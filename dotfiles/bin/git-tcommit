#!/usr/bin/env bash
set -e

# `git commit`, using the latest file modification time as the commit and author
# dates, when GIT_AUTHOR_DATE and GIT_COMMITTER_DATE are not provided.

latest="$(git diff --staged --diff-filter=d --name-only -z |
  xargs -0 stat -f '%m %N' |
  sort -rn |
  head -1)"

if [[ -n $latest ]]; then
  latest_seconds="${latest%% *}"
  latest_file="${latest#* }"
  latest_date="$(date -r "$latest_seconds" +'%Y-%m-%d %H:%M:%S %z')"
  echo "Modify date: $latest_date ($latest_file)"
fi
if [[ -n $GIT_AUTHOR_DATE ]]; then
  echo "Author date: $GIT_AUTHOR_DATE"
fi
if [[ -n $GIT_COMMITTER_DATE ]]; then
  echo "Commit date: $GIT_COMMITTER_DATE"
fi

export GIT_AUTHOR_DATE="${GIT_AUTHOR_DATE-"$latest_seconds"}"
export GIT_COMMITTER_DATE="${GIT_COMMITTER_DATE-"$latest_seconds"}"

git commit "$@"
